# 하둡 분산 파일 시스템

HDFS(Hadoop Distributed File System)는 수십 테라바이트 또는 페타바이트 이상의 대용량 파일을 분산돈 서버에 저장하고, 많은 클라이언트가 저장된 데이터를 빠르게 처리할 수 있게 설계된 파일 시스템이다.

## HDFS 기초

기존에도 DAS, NAS, SAN과 같은 대용량 파일 시스템이 있었으며, HDFS 또한 이러한 대용량 파일 시스템과 유사한 점이 많다.

대용량 파일 시스템 | 특징
-------------- | --
DAS(Direct-Attached Storage) | 서버에 직접 연결괸 스토리지이다. 여러 개의 하드디스크를 장착할 수 있는 외장 케이스를 이용하는 방식이다.
NAS(Network-Attached Storage) | 일종의 파일 서버. 별도의 운영체제를 사용하며, 파일 시스템을 안정적으로 공유할 수 있다. 주로 첨부 파일이나 이미지 같은 데이터를 저장하는 데 많이 사용된다.
SAN(Storage Area Network) | 수십에서 수백 대의 SAN 스토리지를 데이터 서버에 연결해 총괄적으로 관리해주는 네트워크를 의미한다. DAS의 단점을 극복하기 위해 개발됐다. DBMS와 같이 안정적이고 빠른 접근이 필요한 데이터를 저장하는 데 사용된다.

HDFS와 기존 대용량 파일 시스템의 가장 큰 차이점은 **저사양 서버를 이용해 스토리지를 구성할 수 있다는 것이다.** HDFS가 기존 대용량 파일 시스템을 완전히 대체하는 것은 아니다. DBMS처럼 고성능과 고가용성이 필요한 경우에는 SAN을, 안정적인 파일 저장이 필요한 경우에는 NAS를 사용한다. 또 전자상거래처럼 트랜젝션이 중요한 경우에는 HDFS가 적합하지 않으며, **대규모 데이터를 저장하거나 배치로 처리하는 경우에 HDFS를 이용하면 된다.**

HDFS는 다음과 같이 네 가지 목표를 가지고 설계되었다.

1. 장애 복구  
HDFS를 구성하는 분산 서버에는 다양한 장애가 발생할 수 있다. HDFS는 장애를 빠른 시간에 감지하고, 대처할 수 있게 설계돼 있다. HDFS에 데이터를 저장하면, 복제 데이터도 함께 저장되어 데이터 유실을 방지한다. 또한 분산 서버 간에는 주기적으로 상태를 체크해 빠른 시간에 장애를 인지하고, 대처할 수 있게 도와준다.

2. 스트리밍 방식의 데이터 접근  
HDFS는 클라이언트의 요청을 빠른 시간 내에 처리하는 것보다는 동일한 시간 내에 더 많은 데이터를 처리하는 것을 목표로 한다. HDFS는 이를 위해 랜덤 방식의 데이터 접근을 고려하지 않는다. HDFS는 랜덤 접근 방식 대신 스트리밍 방식으로 데이터에 접근하도록 설계돼 있다. 그래서 클라이언트는 끊김 없이 연속된 흐름으로 데이터에 접근할 수 있다.

3. 대용량 데이터 저장  
HDFS는 하나의 파일이 기가바이트에서 테라바이트 이상의 크기로 저장될 수 있게 설계되었기 때문에 높은 데이터 전송 대역폭과 하나의 클러스터에서 수백 대의 노드를 지원할 수 있다. 또한 하나의 인스턴스에서는 수백만 개 이상의 파일을 지원한다.

4. 데이터 무결성  
데이터베이스에서 데이터 무결성이란 데이터베이스에 저장되는 데이터의 일관성을 의미한다. HDFS에서는 한 번 저장된 데이터는 더는 수정할 수 없고, 읽기만 가능하게 해서 데이터 무결성을 유지한다. 데이터 수정은 불가능하지만 파일 이동, 삭제, 복사할 수 있는 인터페이스를 제공한다.(하둡 2.0 알파 버전부터는 HDFS에 저장된 파일에 append가 가능하다)

## HDFS 아키텍처

### 블록 구조 파일 시스템

HDFS는 블록 구조의 파일 시스템이다. HDFS에 저장하는 파일은 특정 크기의 블록으로 나눠져 분산된 서버에 저장된다. 블록 크기는 기본적으로 64MB로 설정되어 있으며 하둡 환경설정 파일이나 다른 방법으로 얼마든지 변경할 수 있다. 여러 개의 블록은 동일한 서버에 저장되는 것이 아니라 여러 서버에 나눠서 저장된다.

블록의 크기가 64MB나 되는 이유는 다음과 같다.

**첫째, 디스크 시크 타임(seek time)의 감소**  
디스크의 탐색 시간은 *데이터의 위치를 찾는 데 걸리는 시간*인 시크 타임과 *원하는 데이터의 섹터에 도달하는 데 걸리는 시간*인 서치 타임(search time)의 합이다. 하둡이 개발됐던 시기의 일반적인 디스크 시크 타임은 10ms, 디스크 전송 대역 폭은 100MB/s 였다. HDFS는 시크 타임이 디스크 전송 대역폭을 1%만을 사용하는 데 주안점을 뒀기 때문에 100MB에 근접한 64MB를 사용한 것이다.(하둡 2.0부터는 블록 크기가 128MB로 늘어남)

**둘째, 네임노드가 유지하는 메타데이터의 크기 감소**  
네임노드는 블록 위치, 파일명, 디렉터리 구조, 권한 정보와 같은 메타데이터 정보를 메모리에 저장하고 관리한다. 제한된 메모리 크기에서 네임노드가 관리할 수 있는 블록 개수가 줄어들어서 많은 양의 데이터를 HDFS에 저장할 수 없게 된다.

**셋째, 클라이언트와 네임노드의 통신 감소**  
클라이언트가 HDFS에 저장된 파일을 접근할 때 네임노드에서 해당 파일을 구성하는 블록의 위치를 조회한다. 클라이언트는 스트리밍 방식으로 데이터를 읽고 쓰기 때문에 특별한 경우를 제외하고는 네임노드와 통신할 필요가 없어진다.

![HDFS 파일의 복제 구조](/img/하둡_분산_파일_시스템/HDFS_파일의_복제_구조.png "HDFS 파일의 복제 구조")

예를 들어 위 그림은 200MB 크기의 파일을 HDFS에 저장했을 때 블록이 복제되는 것을 나타낸 그림이다. 파일은 네 개의 블록으로 분리된 후 블록당 3개씩 HDFS에 저장되어 있다.

HDFS는 블록을 저장할 때 기본적으로 3개씩 블록의 복제본을 저장한다. 블록이 복제되어 있기 때문에 특정 서버의 하드디스크에 오류가 생기더라도 복제된 블록을 이용하여 데이터를 조회할 수 있다. 그리고 HDFS의 블록 크기처럼 복제본의 수도 하둡 환경설정 파일에서 수정할 수 있다.

### 네임노드와 데이터노드

HDFS는 **마스터-슬레이브(Master-Slave) 아키텍처이다.** 마스터 서버는 네임노드(NameNode)이며, 슬레이브 서버는 데이터노드(DataNode)이다.

![HDFS 아키텍처](/img/하둡_분산_파일_시스템/HDFS_아키텍처.png "HDFS 아키텍처")

#### 네임노드

HDFS의 마스터 서버인 네임노드는 다음과 같은 기능을 수행한다.

* 메타데이터 관리  
네임노드는 파일 시스템을 유지하기 위한 메타데이터를 관리한다. 메타데이터는 파일 시스템 이미지(파일명, 디렉터리, 크기, 권환)와 파일에 대한 블록 매핑 정보로 구성된다. 네임노드는 클라이언트에게 빠르게 응답할 수 있게 메모리에 전체 메타데이터를 로딩해서 관리한다.

* 데이터노드 모니터링  
데이터노드는 네임노드에게 3초마다 하트비트(heartbeat) 메세지를 전송한다. 하트비트는 데이터노드 상태 정보와 데이터노드에 저장되어 있는 블록의 목록으로 구성된다. 네임노드는 하트비트를 이용해 데이터노드의 실행 상태와 용량을 모니터링한다. 그리고 일정 기간 동안 하트비트를 전송하지 않는 데이터노드가 있을 경우 장애가 발생한 서버로 판단한다.

* 블록 관리  
네임노드는 다양한 방법으로 블록을 관리한다. 우선, 네임노드는 장애가 발생한 데이터노드를 발견하면 해당 데이터노드의 블록을 새로운 데이터노드로 복제한다. 또한 용량이 부족한 데이터노드가 있다면 용량에 여유가 있는 데이터노드로 블록을 이동시킨다. 마지막으로 네임노드는 블록의 복제본 수도 관리한다. 만약 복제본 수와 일치하지 않는 블록이 발견될 경우 추가로 블록을 복제하거나 삭제한다.

* 클라이언트 요청 접수  
클라이언트가 HDFS에 접근하려면 반드시 네임노드에 먼저 접속해야만 한다. HDFS에 파일을 저장하는 경우 기존 파일의 저장 여부와 권한 확인의 절차를 거쳐서 저장을 승인한다. 또한 HDFS에 저장된 파일을 조회하는 경우 블록의 위치 정보를 반환한다.

#### 데이터노드

데이터노드는 클라이언트가 HDFS에 저장하는 파일을 로컬 디스크에 유지한다. 이때 로컬 디스크에 저장되는 파일은 두 종류로 구성된다. 첫 번째 파일은 실제 데이터가 저장되어 있는 로우 데이터, 두 번째 파일은 체크섬이나 파일 생성 일자와 같은 메타데이터가 설정되어 있는 파일이다.