## HDFS 파일 저장

HDFS의 파일 저장은 클라이언트가 네임노드에게 파일 저장을 요청하는 단계, 클라이언트가 데이터노드에게 패킷을 전송하는 단계, 클라이언트가 파일 저장을 완료하는 단계로 구성된다.

### 파일 저장 요청

클라이언트가 HDFS에 파일을 저장하는 경우 파일을 저장하기 위한 스트림을 생성해야 한다. 아래의 그림은 **클라이언트가 네임노드와의 통신 과정을 통해 파일 저장용 스트림 객체를 생성하는 과정**이다.

![파일 저장 스트림 객체 생성](/img/하둡_분산_파일_시스템/파일_저장_스트림_객체_생성.png "파일 저장 스트림 객체 생성")

1. 하둡은 FileSystem이라는 추상 클래스에 일반적인 파일 시스템을 관리하기 위한 메소드를 정의한다. 그리고 이 추상 클래스를 상속받아 각 파일 시스템에 맞게 구현된 다양한 파일 시스템을 제공한다. HDFS에 파일을 저장하는 경우에는 파일 시스템 클래스 중 DistributedFileSystem을 사용한다. 클라이언트는 DistributedFileSystem의 `create` 메소드를 호출해 스트림 객체를 생성한다.

2. DistributedFileSystem은 **클라이언트에게 반환할 스트림 객체로, FSDataOutputStream을 생성한다.** FSDataOutputStream은 데이터노드와 네임노드의 통신을 관리하는 DFSOutputStream을 래핑하는 클래스다. DistributedFileSystem은 DFSOutputStream을 생성하기 위해 DFSClient의 create 메소드를 호출한다.

3. DFSClientsms DFSOutputStream을 생성한다. 이때 DFSOutputStream은 RPC 통신으로, 네임노드의 create 메소드를 호출한다. 네임노드는 클라이언트의 요청이 유효한지 검사를 진행한다. 이미 새성된 파일이거나 권한에 문제가 있거나, 현재 파일 시스템의 용량이 초과한다면 오류가 발생한다. 네임노드느 파일 유효성 검사 결과가 정상일 경우 파일 시스템 이미지에 해당 파일의 엔트리를 추가한다. 마지막으로 네임노드는 클라이언트에게 파일을 저장할 수 있는 제어권을 부여한다.

4. 네임노드의 유효성 검사를 통과했다면 DFSOutputStream 객체가 정상적으로 생성된다. DistributedFileSystem은 DFSOutputStream을 래핑한 FSDataOutputStream을 클라이언트에게 반환한다.

### 패킷 전송

**클라이언트가 네임노드에게서 파일 제어권을 얻게 되면 파일 저장을 진행한다.** 이때 **클라이언트는 파일을 네임노드에게 전송하지 않고 각 데이터노드에 전송한다.** 그리고 저장할 파일은 **패킷 단위로 나눠서 전송한다.**

![패킷 전송 과정](/img/하둡_분산_파일_시스템/패킷_전송_과정.png "패킷 전송 과정")

1. 클라이언트는 스트림 객체의 `write` 매소드를 호출해 파일 저장을 시작한다. DFSOutputStream은 클라이언트가 저장하는 파일을 64K 크기의 **패킷으로 분할**한다.

2. DFSOutputStream은 전송할 패킷을 내부 큐인 데이터큐(dataQueue)에 등록한다. DFSOutputStream의 내부 스레드가 데이터큐에 패킷이 등록된 것을 확인하면 DFSOutputStream의 내장 클래스인 DataStreamer는 네임노드의 addBlock 메소드를 호출한다.

3. 네임노드는 DataStream에게 블록을 저장할 데이터노드 목록을 반환한다. 이 목록은 복제본 수와 동일한 수의 데이터노드를 연결한 파이프라인을 형성한다.

4. DataStreamer는 파이프라인의 첫 번째 데이터노드로부터 패킷 전송을 시작한다. 데이터노드는 클라이언트와 다른 데이터노드로부터 패킷을 주고받기 위해 DataXceiverServer 데몬을 실행한다. DataXceiverServer는 클라이언트 및 다른 데이터노드와 패킷 교환 기능을 제공한다.

5. 각 데이터노드는 패킷이 정상적으로 저장되면 자신에게 패킷을 전송한 데이터노드에게 ACK 메세지를 전송한다. ACK 메세지는 패킷 수신이 정상적으로 완료됐다는 승인 메세지이다. 승인 메세지는 파이프라인을 통해 DFSOutputStream에게까지 전달된다.

6. 각 데이터노드는 패킷 저장이 완료되면 네임노드의 blockReceived 메소드를 호출한다. 이를 통해 네임노드는 해당 블록이 정상적으로 저장됐다는 것을 인지한다.

7. DFSOutputStream의 내부 스레드인 ResponseProcessor는 파이프라인에 있는 모든 데이터노드로부터 승인 메세지를 받게 되면 해당 패킷을 승인큐에서 제거한다. 만약 패킷을 전송하는 중에 장애가 발생하면 승인큐에 있는 모든 패킷을 데이터큐로 이동한다. 그리고 네임노드에게서 장애가 발생한 데이터노드가 제거된 새로운 데이터 노드 목록을 내려받는다. 마지막으로 새로운 파이프라인을 생성한 후 다시 패킷 전송 작업을 시작한다.

### 파일 닫기

위의 과정이 완료 됐으면 스트림을 받고 파일 저장을 완료할 차례이다.

![파일 닫기](/img/하둡_분산_파일_시스템/파일_닫기.png "파일 닫기")

1. 클라이언트는 DistributedFileSystem의 `close` 메소드를 호출해 파일 닫기를 요청한다.

2. DistributedFileSystem은 DFSOutputStream의 close 메소드를 호출한다. 이 메소드는 DFSOutputStream에 남아 있는 모든 패킷을 파이프라인으로 플러시(flush)한다.

3. DFSOutputStream은 네임노드의 `complete` 메소드를 호출해 패킷이 정상적으로 저장됐는지 확인한다. 네임노드의 블록 복제본 수만 저장됐다면 complete 메소드는 true를 반환한다. DFSOutputStream은 true를 반환받으면 파일 저장이 완료된 것으로 설정한다.