## 맵리듀스 프로세스

### 맵 단계

첫 번째 단계는 입력 파일을 읽어 맵의 출력 데이터를 생성하는 맵 처리 단계이다.

![맵 처리 단계](/img/맵리듀스/맵_처리_단계.png "맵 처리 단계")

1. 맵리듀스는 HDFS에 저장된 파일을 읽어서 배치 처리를 한다. 이때 HDFS에 저장된 데이터는 대부분 큰 규모의 데이터이다. 맵리듀스 프레임워크는 이러한 대용량 파일을 처리하기 위해 입력 데이터 파일을 입력 스필릿(InputSplit)이라는 **고정된 크기의 조각**으로 분리한다. 이때 HDFS에 저장된 블록이 실제로 다시 분리되는 것이 아니라 가상으로 블록을 분리하는 것이다. 입력 스플릿을 생성하는 과정을 **스플릿(split)을 한다고 하며, 입력 스플릿별로 하나의 맵 태스크가 생성된다. 마지막으로 각 입력 스플릿은 맵 태스크의 입력 데이터로 전달된다.

2. 맵 태스크는 입력 스플릿의 데이터를 레코드 단위로, 즉 한 줄씩 읽어서 사용자가 정의한 맵 함수를 실행한다. 맵 태스크의 출력 데이터는 태스크트래커가 실행되는 서버의 로컬 디스크에 저장되며, 맵의 출력키를 기준으로 정렬된다. HDFS에 저장하지 않는 이유는 중간 데이터라서 영구적으로 보관할 필요가 없기 때문이며, 잡이 완료될 경우 중간 데이터는 모두 삭제된다.

### 셔플 단계

![셔플 단계](/img/맵리듀스/셔플_단계.png "셔플 단계")

맵 태스크의 출력 데이터는 중간 데이터이며, 리듀스 태스크는 이 데이터를 내려받아 연산을 수행해야 한다. 맵리듀스 프레임워크는 이러한 작업이 진행될 수 있게 `셔플(Shuffle)`을 지원한다. 셔플은 **맵 태스크의 출력 데이터가 리듀스 태스크에게 전달되는 일련의 과정**을 의미한다.

1. 파티셔너는 맵의 출력 레코드를 읽어서 출력키의 해시값을 구한다. 각 해시값은 레코드가 속하는 파티션 번호로 사용된다. 파티션은 실행될 리듀스 태스크 개수만큼 생성된다.

2. 파티셔닝된 맵의 출력 데이터는 네트워크를 통해 리듀스 태스크에게 전달된다. 하지만 모든 맵의 출력이 동시에 완료되지 않기 때문에 리듀스 태스크는 자신이 처리할 데이터가 모일 때까지 대기한다. 리듀스 태스크는 맵의 출력 데이터가 모두 모이면 데이터를 정렬하고, 하나의 **입력 데이터로 병합**한다.

3. 리듀스 태스크는 병합된 데이터를 레코드 단위로 읽어 들인다.

### 리듀스 단계

리듀스 단계는 사용자에게 전달할 출력 파일을 생성한다.

![리듀스 단계](/img/맵리듀스/리듀스_단계.png "리듀스 단계")

1. 리듀스 태스크는 사용자가 정의한 리듀스 함수를 레코드 단위로 실행한다. 이때 리듀스 태스크가 읽어 들이는 데이터는 입력키와 입력키에 해당하는 입력값의 목록으로 구성된다. 

2. 리듀스 함수가 출력한 데이터는 HDFS에 저장된다. HDFS에는 리듀스 개수만큼 출력 파일이 생성되며, 파일명은 *part-nnnnn*으로 설정된다. 여기서 *nnnnn*은 파티션 번호를 의미하며, 00000부터 1씩 증가된다.